# 번역 API 서버

## 개요
딥러닝 번역 모델을 API로 제공하기 위한 python 서버를 구축하였습니다.

## API 서버를 따로 사용하는 이유
- 딥러닝 모델은 GPU를 사용하여 성능을 극대화 할 수 있기 때문에 cuda를 사용할 수 있고 GPU성능이 뛰어난 PC에서 사용할 수 있도록 따로 API서버를 사용하여 운영하였습니다.
- 모델을 실행하기 위한 언어는 python으로 종속되어있는데 API서버를 배치하면 다른 언어로 백엔드 개발을 할 수 있기 때문에 더 편리합니다.
- 번역을 하지 않는 task의 경우는 백엔드 서버에서 집중적으로 처리할 수 있기 때문에 역할 분리도 간편했습니다. 

## fastAPI의 장점
- 딥러닝 모델을 이용한경우 일반적인 DB CRUD보다 상대적으로 속도가 느립니다. 게다가 파이썬은 웹 서버와 웹 애플리케이션이 통신할때 WSGI(web server gateway interface)를 사용하는데 WSGI는 동기적 처리를 하기 때문에 구조적으로 많은 트래픽을 처리하기엔 속도가 느립니다. Flask 가 WSGI를 사용하고, Django는 3.0 버전부터 사용하지 않는다고 합니다. 
그러나 FastAPI는 ASGI 비동기적 처리를 지원해서 속도가 매우 빠릅니다.

- 두번째로 Pydantic 기반의 Validation이 뛰어납니다 파이썬은 선언하는 과정에서 타입을 가지지 않는데 Pydantic은 매개변수가 가져야할 타입을 명시하여 API를 호출시 flask보다 validation이 뛰어납니다. 

수행 시간이 긴 task이기 때문에 속도가 중요하고 모델을 사용하여 입력을 번역만 하면 되는 간단한 기능이기 때문에 fastAPI를 통해 빠른 속도와 간단한 구현에서 장점을 취하였습니다. 

## https 문제

요구 사항에서 음성 인식을 통해 앱과 웹에서 사용자 발화를 text로 추출할 수 있어야 합니다. 그런데 http를 사용할 경우 웹 브라우저에서 마이크 접근 권한을 거부하기 때문에 https를 사용해야 합니다. https를 이용하여 클라이언트와 통신할 경우 http를 사용할 수 없기 때문에 https를 사용해야 하는 문제가 있었습니다.
관련된 문제를 해결하기 위해서 다음과 같은 해결책이 제시되었습니다.

1. https를 이용하여 통신한다.
2. kafka를 이용한 메세지 전달을 이용하여 통신한다.
3. gradle을 이용하여 react와 spring을 같이 build하여 하나의 서버에 https를 요청한다.



https는 http에서 SSL(Secure Sockets Layer)를 추가한것과 같습니다. 프로젝트에 https를 적용할 수 있도록 가상으로 key를 발급받아서 사용하였습니다. 물론 학교 프로젝트이며 당장 사용자에게 서비스하지 않고 데모를 하기 위해서 가상으로 발급받은것이지 실제로 서비스나 중요한 프로젝트에서는 인증을 받은 key를 발급받아 사용해야 합니다.

1번 해결책의 경우 react 프로젝트에서 발급한 key에 대한 정보를 알아야 한다는 점이 있었습니다. react에서 https를 위한 운용은 그렇게 어렵지 않다는것을 알았지만 이번 프로젝트를 진행하면서 발생하는 여러 문제점에 대한 학습의 목표도 있었기 때문에 2번의 해결책으로 진행해봤습니다.
2번 해결책인 kafka의 경우에서 사용자가 데이터를 kafka broker에게 바로 전달하고 API 서버에서 consume하여 획득한 데이터를 번역하여 다시 broker에게 전달하는 방식으로 해보았습니다.
메세지 전달 과정에서 서로 다른 언어를 사용하기 때문에 BytesSerializer를 사용해야했고 추가로 바이트 코드의 저장 순서가 맞지 않아 생기는 문제점이 있었습니다. 따라서 바이트 순서를 맞추기 위해서 API 서버에서 빅엔디안 방식으로 전달된 바이트를 리틀 엔디안으로 변경하여 데이터를 처리하고 다시 빅 엔디안으로 전송하도록 하였습니다.
그러나 멀티 쓰레드 환경에서 broker에게 전달한 메세지는 동시성 문제를 가지고 있었습니다. 한 토픽은 여러 파티션으로 이루어져있는데 이 파티션에서 consume을 하는 순서가 보장되어있지 않기 때문에 순서가 뒤죽박죽일 수 있겠다는 생각을 하였습니다. 그보다도 producer에서 동시에 요청을 할 경우 접근을 제한하였기 때문에 이 해결책을 사용할 수 없었습니다.

따라서 3번째 해결책을 이용하였습니다. gradle을 사용하여 react와 spring을 같이 빌드하여 정적 페이지를 react의 빌드 파일에서 제공하고 spring은 요청 받은 데이터를 전달하는 방식으로 운영하였습니다. 이렇게 하면 빌드에 시간이 오래 걸리고 수정이 잦아진다는 문제가 있었지만 불필요하게 react에서도 호스팅하고 spring으로도 호스팅하는 번거로운 일이 없었습니다.

